<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TorrentFlix - Stream Any Torrent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d0d0d;
            min-height: 100vh;
            color: #fff;
        }

        /* Header */
        .header {
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            padding: 20px 40px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            background: linear-gradient(90deg, #e50914, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Main Content */
        .main {
            padding-top: 80px;
            min-height: 100vh;
        }

        /* Hero Section */
        .hero {
            padding: 60px 40px;
            background: linear-gradient(135deg, #1a1a2e 0%, #0d0d0d 100%);
        }

        .search-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .search-container h2 {
            font-size: 2rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        #magnetInput {
            flex: 1;
            padding: 18px 20px;
            border: 2px solid #333;
            border-radius: 8px;
            background: #1a1a1a;
            color: #fff;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        #magnetInput:focus {
            outline: none;
            border-color: #e50914;
        }

        #magnetInput::placeholder {
            color: #666;
        }

        .btn-primary {
            padding: 18px 35px;
            border: none;
            border-radius: 8px;
            background: #e50914;
            color: #fff;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            background: #f40612;
            transform: scale(1.02);
        }

        .btn-primary:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }

        /* Demo Links */
        .demo-section {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .demo-btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border: 1px solid #333;
            border-radius: 20px;
            color: #ccc;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .demo-btn:hover {
            background: rgba(229, 9, 20, 0.3);
            border-color: #e50914;
            color: #fff;
        }

        /* Player Section */
        .player-section {
            padding: 0 40px 40px;
            display: none;
        }

        .player-section.active {
            display: block;
        }

        .player-container {
            max-width: 1200px;
            margin: 0 auto;
            background: #111;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .video-wrapper {
            position: relative;
            background: #000;
        }

        #videoPlayer {
            width: 100%;
            max-height: 70vh;
            display: block;
        }

        /* Progress Bar */
        .download-progress {
            height: 4px;
            background: #333;
        }

        #progressBar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #e50914, #ff6b6b);
            transition: width 0.5s ease;
        }

        /* Info Panel */
        .info-panel {
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: start;
        }

        .torrent-info h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        #statusText {
            color: #888;
            font-size: 0.95rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: flex;
            gap: 25px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #e50914;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Files List */
        .files-panel {
            padding: 0 20px 20px;
            display: none;
        }

        .files-panel.active {
            display: block;
        }

        .files-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        .files-header h4 {
            font-size: 1rem;
            color: #888;
        }

        .files-list {
            display: grid;
            gap: 8px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #1a1a1a;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-item:hover {
            background: #252525;
        }

        .file-item.active {
            background: rgba(229, 9, 20, 0.2);
            border: 1px solid #e50914;
        }

        .file-item.non-playable {
            opacity: 0.5;
            cursor: default;
        }

        .file-name {
            font-size: 0.95rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 70%;
        }

        .file-size {
            font-size: 0.85rem;
            color: #666;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            gap: 20px;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #333;
            border-top-color: #e50914;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.1rem;
            color: #888;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 15px 20px;
            }

            .hero {
                padding: 40px 20px;
            }

            .search-box {
                flex-direction: column;
            }

            .player-section {
                padding: 0 15px 30px;
            }

            .info-panel {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                justify-content: space-around;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">Conectando aos peers...</div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="logo">TorrentFlix</div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <!-- Hero / Search Section -->
        <section class="hero">
            <div class="search-container">
                <h2>Stream Qualquer Torrent</h2>
                <div class="search-box">
                    <input type="text" id="magnetInput" placeholder="Cole o magnet link aqui...">
                    <button class="btn-primary" id="startBtn" onclick="startTorrent()">
                        Reproduzir
                    </button>
                </div>
                <div class="demo-section">
                    <span style="color: #666; margin-right: 10px;">Testar com:</span>
                    <button class="demo-btn" onclick="useDemoLink('sintel')">Sintel</button>
                    <button class="demo-btn" onclick="useDemoLink('cosmos')">Cosmos</button>
                    <button class="demo-btn" onclick="useDemoLink('bigbuck')">Big Buck Bunny</button>
                </div>
            </div>
        </section>

        <!-- Player Section -->
        <section class="player-section" id="playerSection">
            <div class="player-container">
                <div class="video-wrapper">
                    <video id="videoPlayer" controls></video>
                </div>
                <div class="download-progress">
                    <div id="progressBar"></div>
                </div>
                <div class="info-panel">
                    <div class="torrent-info">
                        <h3 id="torrentName">-</h3>
                        <p id="statusText">Aguardando...</p>
                    </div>
                    <div class="stats-grid">
                        <div class="stat">
                            <div class="stat-value" id="peers">0</div>
                            <div class="stat-label">Peers</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="downloadSpeed">0 KB/s</div>
                            <div class="stat-label">Download</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="uploadSpeed">0 KB/s</div>
                            <div class="stat-label">Upload</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="progress">0%</div>
                            <div class="stat-label">Progresso</div>
                        </div>
                    </div>
                </div>
                <div class="files-panel" id="filesPanel">
                    <div class="files-header">
                        <h4>Arquivos</h4>
                    </div>
                    <div class="files-list" id="filesList"></div>
                </div>
            </div>
        </section>
    </main>

    <script>
        const API_URL = 'http://localhost:3000/api';
        let currentTorrent = null;
        let statusInterval = null;

        // ========== DEBUG LOGS ==========
        console.log('%c[TorrentFlix] Iniciando...', 'color: #e50914; font-weight: bold;');
        console.log('[TorrentFlix] API URL:', API_URL);

        // Testa conexao com o servidor ao carregar
        async function testServerConnection() {
            console.log('[TorrentFlix] Testando conexao com servidor...');
            try {
                const response = await fetch(`${API_URL}/torrents`, { method: 'GET' });
                if (response.ok) {
                    console.log('%c[TorrentFlix] Servidor ONLINE!', 'color: #00ff00; font-weight: bold;');
                    return true;
                } else {
                    console.error('[TorrentFlix] Servidor respondeu com erro:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('%c[TorrentFlix] Servidor OFFLINE!', 'color: #ff0000; font-weight: bold;');
                console.error('[TorrentFlix] Erro:', error.message);
                console.log('%c[TorrentFlix] Execute: npm install && npm start', 'color: #ffff00; font-weight: bold;');
                return false;
            }
        }

        // Testa ao carregar a pagina
        window.addEventListener('load', async () => {
            const serverOnline = await testServerConnection();
            if (!serverOnline) {
                document.getElementById('statusText').textContent = 'SERVIDOR OFFLINE - Execute: npm start';
                document.getElementById('statusText').style.color = '#ff4444';
            }
        });

        // Demo magnet links (torrents legais)
        const demoLinks = {
            sintel: 'magnet:?xt=urn:btih:08ada5a7a6183aae1e09d831df6748d566095a10&dn=Sintel&tr=udp%3A%2F%2Fexplodie.org%3A6969&tr=udp%3A%2F%2Ftracker.coppersurfer.tk%3A6969&tr=udp%3A%2F%2Ftracker.empire-js.us%3A1337&tr=udp%3A%2F%2Ftracker.leechers-paradise.org%3A6969&tr=udp%3A%2F%2Ftracker.opentrackr.org%3A1337&tr=wss%3A%2F%2Ftracker.btorrent.xyz&tr=wss%3A%2F%2Ftracker.fastcast.nz&tr=wss%3A%2F%2Ftracker.openwebtorrent.com&ws=https%3A%2F%2Fwebtorrent.io%2Ftorrents%2F',
            cosmos: 'magnet:?xt=urn:btih:c9e15763f722f23e98a29decdfae341b98d53056&dn=Cosmos+Laundromat&tr=udp%3A%2F%2Fexplodie.org%3A6969&tr=udp%3A%2F%2Ftracker.coppersurfer.tk%3A6969&tr=udp%3A%2F%2Ftracker.empire-js.us%3A1337&tr=udp%3A%2F%2Ftracker.leechers-paradise.org%3A6969&tr=udp%3A%2F%2Ftracker.opentrackr.org%3A1337&tr=wss%3A%2F%2Ftracker.btorrent.xyz&tr=wss%3A%2F%2Ftracker.fastcast.nz&tr=wss%3A%2F%2Ftracker.openwebtorrent.com',
            bigbuck: 'magnet:?xt=urn:btih:dd8255ecdc7ca55fb0bbf81323d87062db1f6d1c&dn=Big+Buck+Bunny&tr=udp%3A%2F%2Fexplodie.org%3A6969&tr=udp%3A%2F%2Ftracker.coppersurfer.tk%3A6969&tr=udp%3A%2F%2Ftracker.empire-js.us%3A1337&tr=udp%3A%2F%2Ftracker.leechers-paradise.org%3A6969&tr=udp%3A%2F%2Ftracker.opentrackr.org%3A1337&tr=wss%3A%2F%2Ftracker.btorrent.xyz&tr=wss%3A%2F%2Ftracker.fastcast.nz&tr=wss%3A%2F%2Ftracker.openwebtorrent.com'
        };

        function useDemoLink(name) {
            document.getElementById('magnetInput').value = demoLinks[name];
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showLoading(show, text = 'Conectando aos peers...') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            loadingText.textContent = text;
            overlay.classList.toggle('active', show);
        }

        function isPlayableFile(filename) {
            const playable = ['.mp4', '.webm', '.mkv', '.avi', '.mov', '.m4v', '.ogv', '.mp3', '.ogg', '.wav', '.flac'];
            return playable.some(ext => filename.toLowerCase().endsWith(ext));
        }

        async function startTorrent() {
            const magnetUri = document.getElementById('magnetInput').value.trim();
            console.log('[TorrentFlix] ====== INICIANDO TORRENT ======');
            console.log('[TorrentFlix] Magnet URI:', magnetUri.substring(0, 80) + '...');

            if (!magnetUri) {
                alert('Por favor, insira um magnet link');
                return;
            }

            showLoading(true, 'Conectando aos peers...');

            try {
                console.log('[TorrentFlix] Enviando POST para:', `${API_URL}/torrent`);

                const response = await fetch(`${API_URL}/torrent`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ magnetUri })
                });

                console.log('[TorrentFlix] Response status:', response.status);
                console.log('[TorrentFlix] Response ok:', response.ok);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[TorrentFlix] Erro do servidor:', errorText);
                    throw new Error('Falha ao adicionar torrent: ' + errorText);
                }

                const torrent = await response.json();
                console.log('[TorrentFlix] Torrent recebido:', torrent);
                currentTorrent = torrent;

                document.getElementById('torrentName').textContent = torrent.name;
                document.getElementById('playerSection').classList.add('active');

                // Lista arquivos
                const filesList = document.getElementById('filesList');
                filesList.innerHTML = '';

                torrent.files.forEach((file, index) => {
                    const div = document.createElement('div');
                    div.className = 'file-item' + (isPlayableFile(file.name) ? '' : ' non-playable');
                    div.innerHTML = `
                        <span class="file-name">${file.name}</span>
                        <span class="file-size">${formatBytes(file.size)}</span>
                    `;
                    if (isPlayableFile(file.name)) {
                        div.onclick = () => playFile(index, div);
                    }
                    filesList.appendChild(div);
                });

                document.getElementById('filesPanel').classList.add('active');

                // Auto-play primeiro arquivo de video
                const firstVideoIndex = torrent.files.findIndex(f => isPlayableFile(f.name));
                if (firstVideoIndex !== -1) {
                    const fileElements = document.querySelectorAll('.file-item');
                    playFile(firstVideoIndex, fileElements[firstVideoIndex]);
                }

                // Inicia polling de status
                startStatusPolling();

                showLoading(false);
            } catch (error) {
                showLoading(false);
                console.error('%c[TorrentFlix] ERRO COMPLETO:', 'color: #ff0000; font-weight: bold;');
                console.error('[TorrentFlix] Tipo:', error.name);
                console.error('[TorrentFlix] Mensagem:', error.message);
                console.error('[TorrentFlix] Stack:', error.stack);

                if (error.message.includes('Failed to fetch')) {
                    console.error('%c[TorrentFlix] O servidor nao esta rodando!', 'color: #ff0000; font-weight: bold;');
                    console.log('%c[TorrentFlix] Solucao: Abra outro terminal e execute:', 'color: #ffff00;');
                    console.log('%c  cd D:\\Sistemas\\torrentflix', 'color: #00ffff;');
                    console.log('%c  npm install', 'color: #00ffff;');
                    console.log('%c  npm start', 'color: #00ffff;');
                    alert('SERVIDOR OFFLINE!\n\nAbra um terminal e execute:\n\ncd D:\\Sistemas\\torrentflix\nnpm install\nnpm start');
                } else {
                    alert('Erro: ' + error.message);
                }
            }
        }

        function playFile(fileIndex, element) {
            document.querySelectorAll('.file-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');

            const video = document.getElementById('videoPlayer');
            video.src = `${API_URL}/stream/${currentTorrent.infoHash}/${fileIndex}`;
            video.load();
            video.play().catch(e => console.log('Autoplay blocked'));

            document.getElementById('statusText').textContent = `Reproduzindo: ${currentTorrent.files[fileIndex].name}`;
        }

        async function updateStatus() {
            if (!currentTorrent) return;

            try {
                const response = await fetch(`${API_URL}/torrent/${currentTorrent.infoHash}/status`);
                if (!response.ok) return;

                const status = await response.json();

                document.getElementById('peers').textContent = status.numPeers;
                document.getElementById('downloadSpeed').textContent = formatBytes(status.downloadSpeed) + '/s';
                document.getElementById('uploadSpeed').textContent = formatBytes(status.uploadSpeed) + '/s';
                document.getElementById('progress').textContent = (status.progress * 100).toFixed(1) + '%';
                document.getElementById('progressBar').style.width = (status.progress * 100) + '%';

                if (status.done) {
                    document.getElementById('statusText').textContent = 'Download completo - Seeding';
                }
            } catch (error) {
                console.error('Status error:', error);
            }
        }

        function startStatusPolling() {
            if (statusInterval) clearInterval(statusInterval);
            statusInterval = setInterval(updateStatus, 1000);
            updateStatus();
        }

        function stopStatusPolling() {
            if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
        }

        // Limpa intervalo quando a pÃ¡gina for fechada
        window.addEventListener('beforeunload', stopStatusPolling);

        // Enter para iniciar
        document.getElementById('magnetInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') startTorrent();
        });
    </script>
</body>
</html>
